<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / iOS Standalone Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DuoFocus">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="format-detection" content="telephone=no">

    <title>DuoFocus Timer</title>
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="pwa-192x192.png">

    <!-- 內嵌 Manifest -->
    <link rel="manifest" href='data:application/json;charset=utf-8,%7B%22name%22%3A%22DuoFocus%20Timer%22%2C%22short_name%22%3A%22DuoFocus%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23FFFFFF%22%2C%22theme_color%22%3A%22%23FFFFFF%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22pwa-192x192.png%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        unfinished: '#4F9D9D', // Teal
                        finished: '#FFFFFF',   // White
                    },
                    fontFamily: {
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 20px 40px -15px rgba(79, 157, 157, 0.15)',
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #FFFFFF;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            box-sizing: border-box;
        }
        * {
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        input {
            user-select: text;
            -webkit-user-select: text;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "vite": "https://aistudiocdn.com/vite@^7.2.6",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1",
    "vite-plugin-pwa": "https://aistudiocdn.com/vite-plugin-pwa@^1.2.0"
  }
}
</script>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- 設定：API KEY ---
        const DEFAULT_API_KEY = ""; 

        // --- ICONS (依照參考圖重新繪製) ---
        const Icons = {
            Play: ({ className }) => (
                <svg viewBox="0 0 24 24" fill="currentColor" className={className}>
                    <path d="M8 5v14l11-7z" />
                </svg>
            ),
            Pause: ({ className }) => (
                <svg viewBox="0 0 24 24" fill="currentColor" className={className}>
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                </svg>
            ),
            // 細線風格的 Reset
            Reset: ({ className }) => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                    <path d="M3 3v5h5" />
                </svg>
            ),
            // 依照參考圖繪製的齒輪 (空心圓，細線)
            Settings: ({ className }) => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                     <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                     <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                </svg>
            ),
            Sparkles: ({ className }) => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                    <path d="M5 3v4M9 5h4M5 9v4M1 5h4" />
                </svg>
            ),
            Close: ({ className }) => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M18 6 6 18M6 6l12 12" />
                </svg>
            )
        };

        // --- CLOCK COMPONENT ---
        const AnalogClock = ({ remainingSeconds, className }) => {
            const minutes = remainingSeconds / 60;
            const angle = Math.min(359.9, minutes * 6);
            
            // 參數設定
            const r = 46; 
            const cx = 50; 
            const cy = 50;
            
            // 扇形計算 (從 12 點鐘方向開始順時針或逆時針，這裡採用 Visual Timer 邏輯)
            // Visual Timer 通常是：有多少時間，扇形就多大。
            // 0度在上方(12點)，計算結束點
            const endAngleRad = (angle - 90) * (Math.PI / 180);
            const endX = cx + r * Math.cos(endAngleRad);
            const endY = cy + r * Math.sin(endAngleRad);
            const largeArcFlag = angle > 180 ? 1 : 0;
            
            const wedgePath = minutes >= 60 
                ? `M 50 ${50 - r} A ${r} ${r} 0 1 1 49.99 ${50 - r} Z` 
                : `M ${cx} ${cy} L 50 ${50 - r} A ${r} ${r} 0 ${largeArcFlag} 1 ${endX} ${endY} Z`;

            // 輔助：刻度與數字
            const renderFaceContent = (color) => (
                <g fill={color} stroke={color}>
                    {/* 刻度 */}
                    {Array.from({ length: 60 }).map((_, i) => {
                        const isHour = i % 5 === 0;
                        const length = isHour ? 3.5 : 1.5;
                        const width = isHour ? 0.8 : 0.4;
                        const startY = 50 - r + 0.5; // 稍微往內一點點
                        return (
                            <line 
                                key={`t-${i}`} 
                                x1="50" y1={startY} x2="50" y2={startY + length} 
                                stroke={color} 
                                strokeWidth={width} 
                                transform={`rotate(${i * 6} 50 50)`} 
                            />
                        );
                    })}
                    {/* 數字 (5, 10, ... 60) */}
                    {Array.from({ length: 12 }).map((_, i) => {
                        const val = (i + 1) * 5; // 5, 10, 15...
                        // 60 顯示為 60 還是 0? 參考圖顯示 60 在上方
                        const displayVal = val;
                        
                        const deg = val * 6; // 30, 60...
                        const rad = (deg - 90) * (Math.PI / 180);
                        const dist = r - 8.5; // 數字距離圓心的距離
                        
                        const nx = 50 + dist * Math.cos(rad);
                        const ny = 50 + dist * Math.sin(rad);
                        
                        return (
                            <text key={`n-${val}`} x={nx} y={ny} 
                                textAnchor="middle" dominantBaseline="central" 
                                fontSize="4" fontWeight="600" 
                                fill={color} stroke="none" className="font-sans">
                                {displayVal}
                            </text>
                        );
                    })}
                </g>
            );

            return (
                <svg viewBox="0 0 100 100" className={className}>
                    <defs>
                        <mask id="wedgeMask">
                            <rect x="0" y="0" width="100" height="100" fill="black" />
                            <path d={wedgePath} fill="white" />
                        </mask>
                    </defs>

                    {/* 1. 背景底盤 (白色) */}
                    <circle cx="50" cy="50" r="49" fill="currentColor" className="text-finished" />

                    {/* 2. 底層刻度 (Teal) - 顯示在沒有扇形的地方 */}
                    <g className="text-unfinished">{renderFaceContent('currentColor')}</g>

                    {/* 3. 扇形 (Teal) */}
                    <path d={wedgePath} fill="currentColor" className="text-unfinished transition-[d] duration-300 ease-linear" />

                    {/* 4. 上層刻度 (白色) - 透過 Mask 顯示在扇形上方 */}
                    <g className="text-finished" mask="url(#wedgeMask)">{renderFaceContent('currentColor')}</g>

                    {/* 5. 中心圓點 (Teal) */}
                    <circle cx="50" cy="50" r="3.5" fill="currentColor" className="text-unfinished" />
                </svg>
            );
        };

        // --- GEMINI SERVICE ---
        const getFocusTip = async (durationMinutes, apiKey) => {
            if (!apiKey) return "請至設定輸入 API Key";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [{
                        text: `Give me a single, short, impactful sentence of advice for staying focused during a ${durationMinutes}-minute deep work session. No quotes. Traditional Chinese.`
                    }]
                }]
            };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "專注當下，一步一腳印。";
            } catch (e) {
                console.error(e);
                return "保持冷靜，繼續前進。";
            }
        };

        // --- MAIN APP ---
        const App = () => {
            const [timeSettings, setTimeSettings] = useState({ minutes: 25, seconds: 0 });
            const [totalSeconds, setTotalSeconds] = useState(1500);
            const [remainingSeconds, setRemainingSeconds] = useState(1500);
            const [status, setStatus] = useState('IDLE');
            const [showSettings, setShowSettings] = useState(false);
            const [apiKey, setApiKey] = useState(DEFAULT_API_KEY);
            const [focusTip, setFocusTip] = useState(null);
            const [loadingTip, setLoadingTip] = useState(false);
            
            const rafRef = useRef(null);
            const endTimeRef = useRef(null);

            // 初始化讀取
            useEffect(() => {
                const savedKey = localStorage.getItem('GEMINI_API_KEY');
                if (savedKey) setApiKey(savedKey);
                const savedTime = localStorage.getItem('TIMER_SETTINGS');
                if (savedTime) {
                    const parsed = JSON.parse(savedTime);
                    setTimeSettings(parsed);
                    const secs = parsed.minutes * 60 + parsed.seconds;
                    setTotalSeconds(secs);
                    setRemainingSeconds(secs);
                }
            }, []);

            // 倒數邏輯
            const tick = useCallback(() => {
                if (!endTimeRef.current) return;
                const now = Date.now();
                const left = Math.ceil((endTimeRef.current - now) / 1000);
                if (left <= 0) {
                    setRemainingSeconds(0);
                    setStatus('COMPLETED');
                    // 播放提示音
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        const ctx = new AudioContext();
                        const osc = ctx.createOscillator();
                        const g = ctx.createGain();
                        osc.connect(g);
                        g.connect(ctx.destination);
                        osc.start();
                        g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                        osc.stop(ctx.currentTime + 0.5);
                    }
                } else {
                    setRemainingSeconds(left);
                    rafRef.current = requestAnimationFrame(tick);
                }
            }, []);

            const startTimer = () => {
                setStatus('RUNNING');
                endTimeRef.current = Date.now() + remainingSeconds * 1000;
                rafRef.current = requestAnimationFrame(tick);
            };

            const pauseTimer = () => {
                setStatus('PAUSED');
                cancelAnimationFrame(rafRef.current);
                endTimeRef.current = null;
            };

            const resetTimer = () => {
                setStatus('IDLE');
                cancelAnimationFrame(rafRef.current);
                endTimeRef.current = null;
                setRemainingSeconds(totalSeconds);
            };

            const saveSettings = () => {
                const total = timeSettings.minutes * 60 + timeSettings.seconds;
                setTotalSeconds(total);
                setRemainingSeconds(total);
                setStatus('IDLE');
                localStorage.setItem('TIMER_SETTINGS', JSON.stringify(timeSettings));
                localStorage.setItem('GEMINI_API_KEY', apiKey);
                setShowSettings(false);
            };

            const fetchTip = async () => {
                setLoadingTip(true);
                const tip = await getFocusTip(timeSettings.minutes, apiKey);
                setFocusTip(tip);
                setLoadingTip(false);
            };

            return (
                <div className="h-full w-full flex flex-col landscape:flex-row items-center justify-center bg-finished text-unfinished relative overflow-hidden">
                    
                    {/* --- 1. CLOCK CONTAINER (Squircle) --- */}
                    <div className="flex-none p-6">
                        <div className="relative w-[80vw] h-[80vw] max-w-[360px] max-h-[360px] landscape:w-[420px] landscape:h-[420px] aspect-square bg-finished border-[5px] border-unfinished rounded-[40px] shadow-soft p-6 sm:p-8 flex items-center justify-center">
                            <AnalogClock remainingSeconds={remainingSeconds} className="w-full h-full" />
                            
                            {/* 完成狀態遮罩 */}
                            {status === 'COMPLETED' && (
                                <div className="absolute inset-0 z-10 bg-finished/60 rounded-[35px] flex items-center justify-center backdrop-blur-[1px]">
                                    <span className="bg-unfinished text-finished px-6 py-2 rounded-full text-lg font-bold tracking-widest shadow-lg animate-pulse">
                                        完成
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* --- 2. CONTROLS CONTAINER --- */}
                    {/* 直向：在下方 / 橫向：在右側 */}
                    <div className="flex flex-col items-center justify-center gap-8 px-8 landscape:h-[420px] landscape:items-start landscape:justify-center landscape:pl-12">
                        
                        {/* Buttons Group */}
                        <div className="flex items-center gap-6">
                            
                            {/* Settings: Outline Circle + Thin Gear Icon */}
                            <button onClick={() => setShowSettings(true)} disabled={status === 'RUNNING'} 
                                className="w-14 h-14 rounded-full border-2 border-unfinished flex items-center justify-center text-unfinished hover:bg-unfinished/10 transition-colors active:scale-95 disabled:opacity-40">
                                <Icons.Settings className="w-6 h-6" />
                            </button>

                            {/* Play/Pause: Solid Circle + White Icon */}
                            {status === 'RUNNING' ? (
                                <button onClick={pauseTimer} 
                                    className="w-20 h-20 rounded-full bg-unfinished text-finished flex items-center justify-center shadow-lg hover:shadow-xl hover:opacity-90 transition-all active:scale-95">
                                    <Icons.Pause className="w-8 h-8" />
                                </button>
                            ) : (
                                <button onClick={startTimer} disabled={status === 'COMPLETED'}
                                    className="w-20 h-20 rounded-full bg-unfinished text-finished flex items-center justify-center shadow-lg hover:shadow-xl hover:opacity-90 transition-all active:scale-95 disabled:opacity-50 disabled:shadow-none">
                                    <Icons.Play className="w-8 h-8 ml-1" />
                                </button>
                            )}

                            {/* Reset: Outline Circle + Thin Icon */}
                            <button onClick={resetTimer} 
                                className="w-14 h-14 rounded-full border-2 border-unfinished flex items-center justify-center text-unfinished hover:bg-unfinished/10 transition-colors active:scale-95">
                                <Icons.Reset className="w-6 h-6" />
                            </button>
                        </div>

                        {/* Inspire Me Text */}
                        <div className="h-12 flex items-center justify-center landscape:justify-start w-full mt-2">
                            {focusTip ? (
                                <p className="text-sm font-bold text-center landscape:text-left animate-fade-in text-unfinished/90 max-w-[250px]" onClick={() => setFocusTip(null)}>
                                    {focusTip}
                                </p>
                            ) : (
                                <button onClick={fetchTip} disabled={loadingTip} 
                                    className="flex items-center gap-2 text-[11px] font-bold uppercase tracking-[0.2em] text-unfinished/60 hover:text-unfinished transition-colors">
                                    <Icons.Sparkles className={`w-4 h-4 ${loadingTip ? 'animate-spin' : ''}`} />
                                    {loadingTip ? 'THINKING...' : 'INSPIRE ME'}
                                </button>
                            )}
                        </div>
                    </div>

                    {/* --- SETTINGS MODAL --- */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-finished/80 backdrop-blur-sm" onClick={() => setShowSettings(false)}></div>
                            <div className="relative w-full max-w-[320px] bg-finished border-2 border-unfinished rounded-3xl p-8 shadow-2xl animate-fade-in">
                                <button onClick={() => setShowSettings(false)} className="absolute top-4 right-4 text-unfinished/60 hover:text-unfinished"><Icons.Close className="w-6 h-6" /></button>
                                
                                <h2 className="text-center text-lg font-bold uppercase tracking-widest text-unfinished mb-8">Timer Settings</h2>
                                
                                <div className="flex items-center justify-center gap-2 font-mono text-unfinished mb-8">
                                    <div className="flex flex-col items-center">
                                        <input type="number" value={timeSettings.minutes} onChange={e=>setTimeSettings({...timeSettings, minutes: Math.max(0, +e.target.value)})} 
                                            className="w-20 text-5xl text-center bg-transparent border-b-2 border-unfinished/30 focus:border-unfinished outline-none p-2" />
                                        <span className="text-[10px] font-bold mt-2 uppercase tracking-wider opacity-60">Minutes</span>
                                    </div>
                                    <div className="text-4xl pb-8 opacity-50">:</div>
                                    <div className="flex flex-col items-center">
                                        <input type="number" value={timeSettings.seconds} onChange={e=>setTimeSettings({...timeSettings, seconds: Math.min(59, Math.max(0, +e.target.value))})} 
                                            className="w-20 text-5xl text-center bg-transparent border-b-2 border-unfinished/30 focus:border-unfinished outline-none p-2" />
                                        <span className="text-[10px] font-bold mt-2 uppercase tracking-wider opacity-60">Seconds</span>
                                    </div>
                                </div>

                                <div className="mb-6">
                                    <input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="Gemini API Key (Optional)" 
                                        className="w-full p-3 bg-unfinished/5 border border-unfinished/20 rounded-xl outline-none focus:border-unfinished text-unfinished placeholder-unfinished/40 text-xs text-center transition-colors" />
                                </div>

                                <button onClick={saveSettings} className="w-full py-3 bg-unfinished text-finished font-bold uppercase tracking-widest rounded-xl shadow-md hover:shadow-lg active:scale-95 transition-all">
                                    Start Focus
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>