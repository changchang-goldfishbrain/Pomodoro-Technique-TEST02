<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / iOS Standalone Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- 設定狀態列為黑色半透明，讓內容延伸到頂部 -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DuoFocus">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="format-detection" content="telephone=no">

    <title>DuoFocus Timer</title>
    
    <!-- Icons: 請確保 public 資料夾中有這些圖片，或直接放在與 index.html 同層 -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="pwa-192x192.png">

    <!-- 內嵌 Manifest (Android 支援) -->
    <link rel="manifest" href='data:application/json;charset=utf-8,%7B%22name%22%3A%22DuoFocus%20Timer%22%2C%22short_name%22%3A%22DuoFocus%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23FFFFFF%22%2C%22theme_color%22%3A%22%23FFFFFF%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22pwa-192x192.png%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        unfinished: '#4F9D9D', // Teal
                        finished: '#FFFFFF',   // White
                    },
                    fontFamily: {
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    screens: {
                        'landscape': {'raw': '(orientation: landscape)'},
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(79, 157, 157, 0.2)',
                        'inner-soft': 'inset 0 2px 10px 0 rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>

    <!-- React & Babel (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* iOS Safe Area Fixes */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* 禁止捲動 */
            background-color: #FFFFFF;
            /* 讓內容避開瀏海與底部橫條 */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            box-sizing: border-box;
        }

        /* 禁止選取與縮放 */
        * {
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* 輸入框例外，允許輸入 */
        input {
            user-select: text;
            -webkit-user-select: text;
        }

        /* 隱藏捲軸但允許內容捲動 (如果需要) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 動畫 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "vite": "https://aistudiocdn.com/vite@^7.2.6",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1",
    "vite-plugin-pwa": "https://aistudiocdn.com/vite-plugin-pwa@^1.2.0"
  }
}
</script>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- 設定：API KEY (請在此填入，或在介面中設定) ---
        const DEFAULT_API_KEY = ""; 

        // --- ICONS ---
        const Icons = {
            Play: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path fillRule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clipRule="evenodd" /></svg>
            ),
            Pause: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path fillRule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0A.75.75 0 0 1 15 4.5h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H15a.75.75 0 0 1-.75-.75V5.25Z" clipRule="evenodd" /></svg>
            ),
            Reset: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
            ),
            Settings: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M10.34 1.505a.75.75 0 0 1 .722 0l.44.254a2.25 2.25 0 0 0 2.25 0l.44-.254a.75.75 0 0 1 1.118.667v.44a2.25 2.25 0 0 0 2.25 2.25h.44a.75.75 0 0 1 .667 1.118l-.254.44a2.25 2.25 0 0 0 0 2.25l.254.44a.75.75 0 0 1-.667 1.118h-.44a2.25 2.25 0 0 0-2.25 2.25v.44a.75.75 0 0 1-1.118.667l-.44-.254a2.25 2.25 0 0 0-2.25 0l-.44.254a.75.75 0 0 1-1.118-.667v-.44a2.25 2.25 0 0 0-2.25-2.25h-.44a.75.75 0 0 1-.667-1.118l.254-.44a2.25 2.25 0 0 0 0-2.25l-.254-.44a.75.75 0 0 1 .667-1.118h.44a2.25 2.25 0 0 0 2.25-2.25v-.44a.75.75 0 0 1 .722-.667ZM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" /></svg>
            ),
            Sparkles: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg>
            ),
            Close: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
            )
        };

        // --- CLOCK COMPONENT ---
        const AnalogClock = ({ remainingSeconds, className }) => {
            const minutes = remainingSeconds / 60;
            // Limit angle to avoid rendering glitch at exact 360
            const angle = Math.min(359.9, minutes * 6);
            
            // 縮小半徑，製造「邊框留白」，避免數字貼邊
            const r = 42; // 原本 48 -> 改為 42
            const cx = 50; 
            const cy = 50;
            
            // Wedge Calculation
            const endAngleRad = (angle - 90) * (Math.PI / 180);
            const endX = cx + r * Math.cos(endAngleRad);
            const endY = cy + r * Math.sin(endAngleRad);
            
            const largeArcFlag = angle > 180 ? 1 : 0;
            
            // Wedge Path
            const wedgePath = minutes >= 60 
                ? `M 50 ${50 - r} A ${r} ${r} 0 1 1 49.99 ${50 - r} Z` 
                : `M ${cx} ${cy} L 50 ${50 - r} A ${r} ${r} 0 ${largeArcFlag} 1 ${endX} ${endY} Z`;

            // 輔助函數：畫刻度與數字
            const renderFaceContent = (color) => (
                <g fill={color} stroke={color}>
                    {/* 刻度 */}
                    {Array.from({ length: 60 }).map((_, i) => {
                        const isHour = i % 5 === 0;
                        // 調整刻度起始位置，讓它往內縮
                        const startY = 50 - r; // 貼齊扇形邊緣
                        const length = isHour ? 3 : 1.5;
                        return (
                            <line 
                                key={`t-${i}`} 
                                x1="50" y1={startY} x2="50" y2={startY + length} 
                                stroke={color} 
                                strokeWidth={isHour ? 0.8 : 0.4} 
                                transform={`rotate(${i * 6} 50 50)`} 
                            />
                        );
                    })}
                    {/* 數字 */}
                    {Array.from({ length: 12 }).map((_, i) => {
                        const n = i + 1;
                        const rad = (n * 30 - 90) * (Math.PI / 180);
                        // 縮小數字的半徑，確保不貼邊
                        const numDist = r - 8; // 距離圓心 34
                        const nx = 50 + numDist * Math.cos(rad);
                        const ny = 50 + numDist * Math.sin(rad);
                        return (
                            <text key={`n-${n}`} x={nx} y={ny} textAnchor="middle" dominantBaseline="middle" fontSize="3.5" fontWeight="700" fill={color} stroke="none" className="font-sans">
                                {n * 5}
                            </text>
                        );
                    })}
                </g>
            );

            return (
                <svg viewBox="0 0 100 100" className={className}>
                    {/* Mask Definition */}
                    <defs>
                        <mask id="wedgeMask">
                            <rect x="0" y="0" width="100" height="100" fill="black" />
                            <path d={wedgePath} fill="white" />
                        </mask>
                    </defs>

                    {/* 1. Background Dial (White) - 畫一個稍大的底圓作為背景 */}
                    <circle cx="50" cy="50" r="48" fill="currentColor" className="text-finished" />

                    {/* 2. Base Markings (Teal on White) */}
                    <g className="text-unfinished">{renderFaceContent('currentColor')}</g>

                    {/* 3. Wedge (Teal) */}
                    <path d={wedgePath} fill="currentColor" className="text-unfinished transition-[d] duration-300 ease-linear" />

                    {/* 4. Overlay Markings (White on Teal) */}
                    <g className="text-finished" mask="url(#wedgeMask)">{renderFaceContent('currentColor')}</g>

                    {/* 5. Center Knob */}
                    <circle cx="50" cy="50" r="3" fill="currentColor" className="text-unfinished" />
                </svg>
            );
        };

        // --- GEMINI SERVICE ---
        const getFocusTip = async (durationMinutes, apiKey) => {
            if (!apiKey) return "請至設定輸入 API Key";
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [{
                        text: `Give me a single, short, impactful sentence of advice for staying focused during a ${durationMinutes}-minute deep work session. No quotes. Traditional Chinese.`
                    }]
                }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "專注當下，一步一腳印。";
            } catch (e) {
                console.error(e);
                return "保持冷靜，繼續前進。";
            }
        };

        // --- MAIN APP ---
        const App = () => {
            const [timeSettings, setTimeSettings] = useState({ minutes: 25, seconds: 0 });
            const [totalSeconds, setTotalSeconds] = useState(1500);
            const [remainingSeconds, setRemainingSeconds] = useState(1500);
            const [status, setStatus] = useState('IDLE');
            const [showSettings, setShowSettings] = useState(false);
            const [apiKey, setApiKey] = useState(DEFAULT_API_KEY);
            const [focusTip, setFocusTip] = useState(null);
            const [loadingTip, setLoadingTip] = useState(false);
            
            const rafRef = useRef(null);
            const endTimeRef = useRef(null);

            useEffect(() => {
                const savedKey = localStorage.getItem('GEMINI_API_KEY');
                if (savedKey) setApiKey(savedKey);

                const savedTime = localStorage.getItem('TIMER_SETTINGS');
                if (savedTime) {
                    const parsed = JSON.parse(savedTime);
                    setTimeSettings(parsed);
                    const secs = parsed.minutes * 60 + parsed.seconds;
                    setTotalSeconds(secs);
                    setRemainingSeconds(secs);
                }
            }, []);

            const playBeep = useCallback(() => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.connect(g);
                g.connect(ctx.destination);
                osc.start();
                g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                osc.stop(ctx.currentTime + 0.5);
            }, []);

            const tick = useCallback(() => {
                if (!endTimeRef.current) return;
                const now = Date.now();
                const left = Math.ceil((endTimeRef.current - now) / 1000);

                if (left <= 0) {
                    setRemainingSeconds(0);
                    setStatus('COMPLETED');
                    playBeep();
                } else {
                    setRemainingSeconds(left);
                    rafRef.current = requestAnimationFrame(tick);
                }
            }, [playBeep]);

            const startTimer = () => {
                setStatus('RUNNING');
                endTimeRef.current = Date.now() + remainingSeconds * 1000;
                rafRef.current = requestAnimationFrame(tick);
            };

            const pauseTimer = () => {
                setStatus('PAUSED');
                cancelAnimationFrame(rafRef.current);
                endTimeRef.current = null;
            };

            const resetTimer = () => {
                setStatus('IDLE');
                cancelAnimationFrame(rafRef.current);
                endTimeRef.current = null;
                setRemainingSeconds(totalSeconds);
            };

            const saveSettings = () => {
                const total = timeSettings.minutes * 60 + timeSettings.seconds;
                setTotalSeconds(total);
                setRemainingSeconds(total);
                setStatus('IDLE');
                localStorage.setItem('TIMER_SETTINGS', JSON.stringify(timeSettings));
                localStorage.setItem('GEMINI_API_KEY', apiKey);
                setShowSettings(false);
            };

            const fetchTip = async () => {
                setLoadingTip(true);
                const tip = await getFocusTip(timeSettings.minutes, apiKey);
                setFocusTip(tip);
                setLoadingTip(false);
            };

            return (
                <div className="flex flex-col h-full items-center justify-center bg-finished text-unfinished font-sans landscape:flex-row landscape:gap-12 relative overflow-hidden">
                    
                    {/* Top Decoration Line (Optional, adds detail) */}
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-finished via-unfinished to-finished opacity-20"></div>

                    {/* --- Clock Container --- */}
                    {/* 
                       調整：
                       1. 增加 padding 讓時鐘在卡片內不擁擠。
                       2. 確保卡片是完美的圓角正方形。
                       3. 使用 flex-shrink-0 避免在小螢幕被壓縮。
                    */}
                    <div className="flex-none w-[75vw] h-[75vw] max-w-[340px] max-h-[340px] aspect-square mb-10 landscape:mb-0 landscape:w-[400px] landscape:h-[400px]">
                        <div className="relative w-full h-full bg-finished border-4 border-unfinished rounded-[22%] shadow-soft p-8 flex items-center justify-center">
                            <AnalogClock remainingSeconds={remainingSeconds} className="w-full h-full" />
                            
                            {status === 'COMPLETED' && (
                                <div className="absolute inset-0 flex items-center justify-center z-10 bg-finished/50 rounded-[22%] backdrop-blur-[2px]">
                                    <span className="bg-unfinished text-finished px-8 py-3 rounded-full text-xl font-bold animate-pulse shadow-lg tracking-widest">
                                        完成
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* --- Controls Container --- */}
                    {/* 調整：使用 flex-col 並置中，確保與上方時鐘分開 */}
                    <div className="flex flex-col items-center gap-8 w-full max-w-[340px] px-6">
                        
                        {/* Buttons Row */}
                        <div className="flex items-center justify-center gap-8">
                            {/* Settings (Small) */}
                            <button onClick={() => setShowSettings(true)} disabled={status === 'RUNNING'} className="p-4 rounded-full border-2 border-unfinished text-unfinished hover:bg-unfinished hover:text-finished transition-all active:scale-95 disabled:opacity-30">
                                <Icons.Settings className="w-6 h-6" />
                            </button>

                            {/* Play/Pause (Big) */}
                            {status === 'RUNNING' ? (
                                <button onClick={pauseTimer} className="p-7 rounded-full bg-unfinished text-finished shadow-lg hover:shadow-xl active:scale-95 transition-all">
                                    <Icons.Pause className="w-9 h-9" />
                                </button>
                            ) : (
                                <button onClick={startTimer} disabled={status === 'COMPLETED'} className="p-7 rounded-full bg-unfinished text-finished shadow-lg hover:shadow-xl active:scale-95 transition-all disabled:opacity-50 disabled:shadow-none">
                                    <Icons.Play className="w-9 h-9 translate-x-0.5" />
                                </button>
                            )}

                            {/* Reset (Small) */}
                            <button onClick={resetTimer} className="p-4 rounded-full border-2 border-unfinished text-unfinished hover:bg-unfinished hover:text-finished transition-all active:scale-95">
                                <Icons.Reset className="w-6 h-6" />
                            </button>
                        </div>

                        {/* AI Tip Button */}
                        <div className="h-12 flex items-center justify-center w-full">
                            {focusTip ? (
                                <p className="text-sm font-bold text-center animate-fade-in leading-relaxed select-text cursor-pointer opacity-80 hover:opacity-100" onClick={() => setFocusTip(null)}>
                                    {focusTip}
                                </p>
                            ) : (
                                <button onClick={fetchTip} disabled={loadingTip} className="group flex items-center gap-2 px-4 py-2 rounded-full hover:bg-unfinished/5 transition-all text-xs font-bold uppercase tracking-widest opacity-60 hover:opacity-100">
                                    <Icons.Sparkles className={`w-4 h-4 ${loadingTip ? 'animate-spin' : 'group-hover:scale-110 transition-transform'}`} />
                                    {loadingTip ? '思考中...' : '給點建議'}
                                </button>
                            )}
                        </div>
                    </div>

                    {/* --- Settings Modal --- */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-finished/90 backdrop-blur-sm" onClick={() => setShowSettings(false)}></div>
                            <div className="relative w-full max-w-sm bg-finished border-2 border-unfinished rounded-3xl p-8 shadow-2xl animate-fade-in">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-xl font-bold uppercase tracking-widest text-unfinished">設定時間</h2>
                                    <button onClick={() => setShowSettings(false)} className="p-2 -mr-2 text-unfinished hover:opacity-70"><Icons.Close className="w-6 h-6" /></button>
                                </div>
                                
                                {/* Time Input */}
                                <div className="flex items-center justify-center gap-2 font-mono mb-8">
                                    <div className="flex flex-col items-center">
                                        <input type="number" value={timeSettings.minutes} onChange={e=>setTimeSettings({...timeSettings, minutes: Math.max(0, +e.target.value)})} className="w-20 text-5xl text-center bg-transparent border-b-2 border-unfinished/30 focus:border-unfinished outline-none text-unfinished transition-colors p-2" />
                                        <span className="text-[10px] font-bold mt-2 text-unfinished uppercase tracking-wider">分</span>
                                    </div>
                                    <div className="text-4xl pb-6 text-unfinished/50">:</div>
                                    <div className="flex flex-col items-center">
                                        <input type="number" value={timeSettings.seconds} onChange={e=>setTimeSettings({...timeSettings, seconds: Math.min(59, Math.max(0, +e.target.value))})} className="w-20 text-5xl text-center bg-transparent border-b-2 border-unfinished/30 focus:border-unfinished outline-none text-unfinished transition-colors p-2" />
                                        <span className="text-[10px] font-bold mt-2 text-unfinished uppercase tracking-wider">秒</span>
                                    </div>
                                </div>

                                {/* API Key Input */}
                                <div className="mb-8">
                                    <label className="text-[10px] font-bold uppercase opacity-60 mb-2 block text-unfinished tracking-wider">Gemini API Key (選填)</label>
                                    <input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="貼上 API Key 以啟用 AI 功能" className="w-full p-3 bg-unfinished/5 border border-unfinished/20 rounded-xl outline-none focus:ring-2 focus:ring-unfinished/50 text-unfinished placeholder-unfinished/30 text-sm transition-all" />
                                </div>

                                <button onClick={saveSettings} className="w-full py-4 bg-unfinished text-finished font-bold uppercase tracking-widest rounded-xl shadow-md hover:shadow-lg active:scale-95 transition-all">
                                    確認設定
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>